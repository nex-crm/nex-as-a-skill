#!/usr/bin/env bash
# OpenClaw bootstrap registration helper for Nex.
# Usage: nex-openclaw-register.sh <email> [name] [company_name] [jq-filter]
set -euo pipefail

BASE_URL="http://localhost:300000/api/v1/openclaw/register"
TIMEOUT="${NEX_API_TIMEOUT:-120}"

EMAIL="${1:-}"
NAME="${2:-}"
COMPANY_NAME="${3:-}"
JQ_FILTER="${4:-}"

if [[ -z "$EMAIL" ]]; then
  echo "Usage: nex-openclaw-register.sh <email> [name] [company_name] [jq-filter]" >&2
  exit 2
fi

PAYLOAD=$(jq -cn   --arg email "$EMAIL"   --arg name "$NAME"   --arg company_name "$COMPANY_NAME"   '{email: $email}
   + (if $name != "" then {name: $name} else {} end)
   + (if $company_name != "" then {company_name: $company_name} else {} end)')

RESPONSE=$(curl -s -w '\n%{http_code}' --max-time "$TIMEOUT"   -X POST   -H "Content-Type: application/json"   -H "Accept: application/json"   --data-binary "$PAYLOAD"   "$BASE_URL") || {
  echo "Error: curl request failed" >&2
  exit 4
}

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

if [[ "$HTTP_CODE" -ge 400 ]] 2>/dev/null; then
  echo "Error: HTTP $HTTP_CODE" >&2
  echo "$BODY" >&2
  exit 4
fi

if [[ -n "$JQ_FILTER" ]]; then
  echo "$BODY" | jq "$JQ_FILTER" || {
    echo "Error: jq filter failed" >&2
    exit 5
  }
else
  echo "$BODY"
fi
